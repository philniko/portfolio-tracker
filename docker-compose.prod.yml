# Production Docker Compose Override
# Usage: docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d

version: '3.8'

services:
  postgres:
    restart: always
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}  # Set in production .env
    volumes:
      - /var/lib/postgresql/data:/var/lib/postgresql/data  # Persistent storage
    ports:
      - "127.0.0.1:5432:5432"  # Only expose to localhost

  redis:
    restart: always
    command: redis-server --maxmemory 512mb --maxmemory-policy allkeys-lru
    ports:
      - "127.0.0.1:6379:6379"  # Only expose to localhost

  backend:
    restart: always
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --workers 4
    env_file:
      - .env.production
    ports:
      - "127.0.0.1:8000:8000"  # Only expose to localhost (nginx will proxy)
    volumes:
      - ./backend/app:/app/app:ro  # Read-only in production
      - ./backend/alembic:/app/alembic:ro

  celery_worker:
    restart: always
    env_file:
      - .env.production
    volumes:
      - ./backend/app:/app/app:ro
    deploy:
      replicas: 2  # Run 2 workers for better performance

  celery_beat:
    restart: always
    env_file:
      - .env.production
    volumes:
      - ./backend/app:/app/app:ro

  # Nginx reverse proxy for SSL termination and static file serving
  nginx:
    image: nginx:alpine
    container_name: portfolio_nginx
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro  # SSL certificates
      - ./frontend/dist:/usr/share/nginx/html:ro  # Frontend static files
      - ./nginx/logs:/var/log/nginx  # Nginx logs
    depends_on:
      - backend
    networks:
      - default

networks:
  default:
    driver: bridge
